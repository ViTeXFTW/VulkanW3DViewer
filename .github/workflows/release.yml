name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v0.3.0)'
        required: true

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # Native Linux build (GCC, ubuntu-latest)
  # ─────────────────────────────────────────────────────────────────────────────
  build-linux:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract-version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref }}
          submodules: recursive

      - name: Extract version
        id: extract-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            g++ \
            cmake \
            ninja-build \
            glslc \
            libvulkan-dev \
            vulkan-validationlayers \
            spirv-tools \
            libglfw3-dev \
            libxi-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxkbcommon-dev \
            binutils

      - name: Configure CMake
        run: cmake --preset gcc-release

      - name: Build
        run: cmake --build --preset gcc-release

      - name: Strip binary
        run: strip build/gcc-release/VulkanW3DViewer

      - name: Package artifacts
        run: |
          VERSION=${{ steps.extract-version.outputs.version }}
          PACKAGE_NAME="VulkanW3DViewer-linux-x64-${VERSION}"
          mkdir -p "${PACKAGE_NAME}"
          cp build/gcc-release/VulkanW3DViewer "${PACKAGE_NAME}/"
          cp README.md "${PACKAGE_NAME}/"
          cp LICENSE.md "${PACKAGE_NAME}/"
          tar -czf "${PACKAGE_NAME}.tar.gz" "${PACKAGE_NAME}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: VulkanW3DViewer-linux-x64-${{ steps.extract-version.outputs.version }}.tar.gz

  # ─────────────────────────────────────────────────────────────────────────────
  # Windows build — cross-compiled on ubuntu-latest using MinGW-w64 GCC.
  # This avoids the Windows runner entirely and the Vulkan SDK installer hang.
  # ─────────────────────────────────────────────────────────────────────────────
  build-windows:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref }}
          submodules: recursive

      - name: Extract version
        id: extract-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install cross-compilation dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            g++-mingw-w64-x86-64 \
            binutils-mingw-w64-x86-64 \
            cmake \
            ninja-build \
            glslc \
            curl \
            zip

      - name: Generate Vulkan import library for MinGW
        run: |
          mkdir -p build/vulkan-mingw
          bash cmake/generate-vulkan-mingw-lib.sh build/vulkan-mingw

      - name: Configure CMake (cross-compile to Windows)
        run: |
          cmake -B build/mingw-release \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=cmake/mingw-w64-toolchain.cmake \
            -DVulkan_INCLUDE_DIR="${PWD}/lib/Vulkan-Hpp/Vulkan-Headers/include" \
            -DVulkan_LIBRARY="${PWD}/build/vulkan-mingw/libvulkan-1.a" \
            -DCMAKE_EXE_LINKER_FLAGS="-static-libgcc -static-libstdc++ -static -lpthread"

      - name: Build
        run: cmake --build build/mingw-release

      - name: Strip binary
        run: x86_64-w64-mingw32-strip build/mingw-release/VulkanW3DViewer.exe

      - name: Package artifacts
        run: |
          VERSION=${{ steps.extract-version.outputs.version }}
          PACKAGE_NAME="VulkanW3DViewer-windows-x64-${VERSION}"
          mkdir -p "${PACKAGE_NAME}"
          cp build/mingw-release/VulkanW3DViewer.exe "${PACKAGE_NAME}/"
          cp README.md "${PACKAGE_NAME}/"
          cp LICENSE.md "${PACKAGE_NAME}/"
          zip -r "${PACKAGE_NAME}.zip" "${PACKAGE_NAME}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: VulkanW3DViewer-windows-x64-${{ steps.extract-version.outputs.version }}.zip

  # ─────────────────────────────────────────────────────────────────────────────
  # Create GitHub Release with both artifacts
  # ─────────────────────────────────────────────────────────────────────────────
  create-release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref }}
          fetch-depth: 0
          fetch-tags: true

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-build

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-build

      - name: Generate changelog
        id: changelog
        run: |
          VERSION=${{ needs.build-linux.outputs.version }}
          echo "Generating changelog for $VERSION"

          # Get the previous release tag
          LAST_TAG=$(git describe --tags --abbrev=0 --exclude="$VERSION" 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            echo "No previous release found, generating full history"
            COMMIT_RANGE="HEAD"
          else
            echo "Last release: $LAST_TAG"
            COMMIT_RANGE="${LAST_TAG}..HEAD"
          fi

          # Generate changelog from squashed merge commits (format: "Title (#PR)")
          CHANGELOG=$(git log $COMMIT_RANGE --oneline --grep='(#[0-9]*)' --pretty=format:"- %s" | head -n 50)

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- Initial release"
          fi

          cat > changelog.md << EOF
          ## Changes

          $CHANGELOG

          ## Installation

          Download the appropriate binary for your platform:
          - **Linux**: \`VulkanW3DViewer-linux-x64-${VERSION}.tar.gz\`
          - **Windows**: \`VulkanW3DViewer-windows-x64-${VERSION}.zip\`

          Extract and run the executable. Requires a Vulkan 1.3+ compatible GPU and up-to-date GPU drivers.

          ## Build Info
          - Built with GCC (Linux native, Windows cross-compiled via MinGW-w64)
          - Optimized release build with stripped debug symbols
          - Windows binary is self-contained (no MinGW runtime DLLs required)
          EOF

          cat changelog.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build-linux.outputs.version }}
          name: Release ${{ needs.build-linux.outputs.version }}
          body_path: changelog.md
          draft: false
          prerelease: ${{ contains(needs.build-linux.outputs.version, 'alpha') || contains(needs.build-linux.outputs.version, 'beta') }}
          files: |
            VulkanW3DViewer-linux-x64-${{ needs.build-linux.outputs.version }}.tar.gz
            VulkanW3DViewer-windows-x64-${{ needs.build-linux.outputs.version }}.zip
