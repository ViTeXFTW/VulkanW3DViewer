name: Build and Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_notes: ${{ steps.release-notes.outputs.notes }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version from CMakeLists.txt
        id: version
        run: |
          VERSION=$(grep -oP 'project\(VulkanW3DViewer VERSION \K[0-9]+\.[0-9]+\.[0-9]+' CMakeLists.txt)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
      
      - name: Generate release notes from changelog
        id: release-notes
        run: |
          # Extract Unreleased section from CHANGELOG.md
          NOTES=$(awk '/^## \[Unreleased\]/,/^## \[/{if(!/^## \[/)print}' CHANGELOG.md | sed '/^$/d' | head -n -1)
          
          if [ -z "$NOTES" ]; then
            NOTES="No changelog entries for this release."
          fi
          
          # Write to file to handle multiline
          echo "$NOTES" > release_notes.txt
          
          echo "Release notes generated"
      
      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release_notes.txt

  build-windows:
    needs: prepare-release
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Vulkan SDK
        uses: humbletim/setup-vulkan-sdk@v1.2.0
        with:
          vulkan-query-version: latest
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-use-cache: true
      
      - name: Configure CMake
        run: cmake --preset release
      
      - name: Build
        run: cmake --build build/release --config Release
      
      - name: Package binary
        run: |
          mkdir VulkanW3DViewer-windows
          Copy-Item build/release/VulkanW3DViewer.exe VulkanW3DViewer-windows/
          Copy-Item -Recurse build/release/shaders VulkanW3DViewer-windows/
          Compress-Archive -Path VulkanW3DViewer-windows -DestinationPath VulkanW3DViewer-windows-v${{ needs.prepare-release.outputs.version }}.zip
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: VulkanW3DViewer-windows-v${{ needs.prepare-release.outputs.version }}.zip

  build-linux:
    needs: prepare-release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            clang \
            libvulkan-dev \
            vulkan-tools \
            libglfw3-dev \
            libglm-dev
      
      - name: Configure CMake
        run: cmake --preset release
      
      - name: Build
        run: cmake --build build/release
      
      - name: Package binary
        run: |
          mkdir VulkanW3DViewer-linux
          cp build/release/VulkanW3DViewer VulkanW3DViewer-linux/
          cp -r build/release/shaders VulkanW3DViewer-linux/
          tar -czf VulkanW3DViewer-linux-v${{ needs.prepare-release.outputs.version }}.tar.gz VulkanW3DViewer-linux
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: VulkanW3DViewer-linux-v${{ needs.prepare-release.outputs.version }}.tar.gz

  create-release:
    needs: [prepare-release, build-windows, build-linux]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.prepare-release.outputs.version }}
          name: Release v${{ needs.prepare-release.outputs.version }}
          body_path: release-notes/release_notes.txt
          draft: false
          prerelease: false
          files: |
            windows-build/VulkanW3DViewer-windows-v${{ needs.prepare-release.outputs.version }}.zip
            linux-build/VulkanW3DViewer-linux-v${{ needs.prepare-release.outputs.version }}.tar.gz
      
      - name: Update CHANGELOG
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          DATE=$(date +%Y-%m-%d)
          
          # Replace [Unreleased] with version and date, add new Unreleased section
          awk -v version="$VERSION" -v date="$DATE" '
          /^## \[Unreleased\]/ {
            print "## [Unreleased]"
            print ""
            print "### Added"
            print ""
            print "### Changed"
            print ""
            print "### Fixed"
            print ""
            print "### Removed"
            print ""
            print "## [" version "] - " date
            next
          }
          { print }
          ' CHANGELOG.md > CHANGELOG.tmp
          
          mv CHANGELOG.tmp CHANGELOG.md
      
      - name: Commit CHANGELOG update
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add CHANGELOG.md
          git commit -m "docs: Release v${{ needs.prepare-release.outputs.version }} [skip ci]"
          git push origin main
