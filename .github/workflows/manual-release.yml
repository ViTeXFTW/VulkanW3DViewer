name: Manual Release Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.2.0-alpha)'
        required: true
        type: string

env:
  BUILD_TYPE: release

jobs:
  build-linux:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract-version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set version
        id: extract-version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            libvulkan-dev \
            vulkan-validationlayers \
            spirv-tools \
            libglfw3-dev \
            libxi-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            binutils

      - name: Install Vulkan SDK
        run: |
          wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
          sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-jammy.list https://packages.lunarg.com/vulkan/lunarg-vulkan-jammy.list
          sudo apt-get update
          sudo apt-get install -y vulkan-sdk

      - name: Configure CMake
        run: cmake --preset release
        env:
          CC: clang
          CXX: clang++

      - name: Build
        run: cmake --build --preset release

      - name: Strip binary
        run: strip build/release/VulkanW3DViewer

      - name: Package artifacts
        run: |
          VERSION=${{ steps.extract-version.outputs.version }}
          PACKAGE_NAME="VulkanW3DViewer-linux-x64-${VERSION}"
          mkdir -p "${PACKAGE_NAME}"
          cp build/release/VulkanW3DViewer "${PACKAGE_NAME}/"
          cp README.md "${PACKAGE_NAME}/"
          cp LICENSE.md "${PACKAGE_NAME}/"
          tar -czf "${PACKAGE_NAME}.tar.gz" "${PACKAGE_NAME}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: VulkanW3DViewer-linux-x64-${{ steps.extract-version.outputs.version }}.tar.gz

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set version
        id: extract-version
        shell: bash
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-clang
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-glfw

      - name: Install Vulkan SDK
        shell: powershell
        run: |
          $VulkanVersion = "1.3.290.0"
          $InstallerUrl = "https://sdk.lunarg.com/sdk/download/$VulkanVersion/windows/VulkanSDK-$VulkanVersion-Installer.exe"
          $InstallerPath = "$env:TEMP\VulkanSDK-Installer.exe"

          Write-Host "Downloading Vulkan SDK..."
          Invoke-WebRequest -Uri $InstallerUrl -OutFile $InstallerPath

          Write-Host "Installing Vulkan SDK..."
          Start-Process -FilePath $InstallerPath -ArgumentList "/S" -Wait

          Write-Host "Vulkan SDK installed"

      - name: Configure CMake
        shell: msys2 {0}
        run: |
          export PATH="/mingw64/bin:$PATH"
          export CC=clang
          export CXX=clang++
          cmake --preset release

      - name: Build
        shell: msys2 {0}
        run: |
          export PATH="/mingw64/bin:$PATH"
          cmake --build --preset release

      - name: Strip binary
        shell: msys2 {0}
        run: strip build/release/VulkanW3DViewer.exe

      - name: Package artifacts
        shell: bash
        run: |
          VERSION=${{ steps.extract-version.outputs.version }}
          PACKAGE_NAME="VulkanW3DViewer-windows-x64-${VERSION}"
          mkdir -p "${PACKAGE_NAME}"
          cp build/release/VulkanW3DViewer.exe "${PACKAGE_NAME}/"
          cp README.md "${PACKAGE_NAME}/"
          cp LICENSE.md "${PACKAGE_NAME}/"
          7z a -tzip "${PACKAGE_NAME}.zip" "${PACKAGE_NAME}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: VulkanW3DViewer-windows-x64-${{ steps.extract-version.outputs.version }}.zip

  create-release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-build

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-build

      - name: Generate changelog
        id: changelog
        run: |
          VERSION=${{ needs.build-linux.outputs.version }}
          echo "Generating changelog for $VERSION"

          # Get the last release tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            echo "No previous release found, generating full history"
            COMMIT_RANGE="HEAD"
          else
            echo "Last release: $LAST_TAG"
            COMMIT_RANGE="${LAST_TAG}..HEAD"
          fi

          # Generate changelog from commit messages
          # Looking for squashed merge commits which typically have format: "Title (#PR)"
          CHANGELOG=$(git log $COMMIT_RANGE --oneline --grep='(#[0-9]*)' --pretty=format:"- %s" | head -n 50)

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- Initial release"
          fi

          # Write changelog to file for the release
          cat > changelog.md << EOF
          ## Changes

          $CHANGELOG

          ## Installation

          Download the appropriate binary for your platform:
          - **Linux**: \`VulkanW3DViewer-linux-x64-${VERSION}.tar.gz\`
          - **Windows**: \`VulkanW3DViewer-windows-x64-${VERSION}.zip\`

          Extract and run the executable. Requires Vulkan 1.3+ compatible GPU.

          ## Build Info
          - Built with Clang
          - Optimized release build with stripped debug symbols
          - Includes README.md and LICENSE.md
          EOF

          cat changelog.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.build-linux.outputs.version }}
          name: Release ${{ needs.build-linux.outputs.version }}
          body_path: changelog.md
          draft: false
          prerelease: false
          files: |
            VulkanW3DViewer-linux-x64-${{ needs.build-linux.outputs.version }}.tar.gz
            VulkanW3DViewer-windows-x64-${{ needs.build-linux.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
